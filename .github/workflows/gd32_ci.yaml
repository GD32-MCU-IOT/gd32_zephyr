name: GD32 Boards CI Test

# æ­¤ workflow ä¸“æ³¨äº GD32 å¼€å‘æ¿çš„åŠŸèƒ½æµ‹è¯•ï¼š
# - ç¼–è¯‘æµ‹è¯•ï¼ˆå¤šç§æµ‹è¯•ç”¨ä¾‹ï¼‰
# - å¤–è®¾åŠŸèƒ½æµ‹è¯•ï¼ˆæ ¹æ®å¤–è®¾çŸ©é˜µï¼‰
# - æµ‹è¯•æŠ¥å‘Šç”Ÿæˆ
#
# æ³¨æ„ï¼šä»£ç æ ¼å¼æ£€æŸ¥ï¼ˆCheckpatch/GitLint/Identityç­‰ï¼‰ç”±å…¨å±€ compliance.yml è´Ÿè´£

# ç¯å¢ƒé…ç½®è¯´æ˜
env:
  # West æ¨¡å—æ›´æ–°ç­–ç•¥
  # 'minimal': åªæ›´æ–°å¿…éœ€æ¨¡å— (hal_gigadevice, cmsis, cmsis_6)
  # 'extended': é¢å¤–æ›´æ–°å¸¸ç”¨æ¨¡å— (fatfs, littlefs, mbedtls, net-tools)
  # 'full': æ›´æ–°æ‰€æœ‰ç›¸å…³æ¨¡å— (åŒ…å« mcuboot, lvgl, picolibc ç­‰)
  WEST_UPDATE_STRATEGY: 'minimal'  # å¯é€‰: minimal | extended | full

on:
  push:
    branches:
      - main
      - develop
      - 'feature/gd32-*'
    paths:
      - 'boards/gd/**'
      - 'soc/gd/**'
      - 'dts/gd/**'
      - 'drivers/**'
  pull_request:
    branches:
      - main
      - develop
    paths:
      - 'boards/gd/**'
      - 'soc/gd/**'
      - 'dts/gd/**'
      - 'drivers/**'

permissions:
  contents: read
  checks: write

concurrency:
  group: ${{ github.workflow }}-${{ github.event_name }}-${{ github.head_ref || github.ref }}
  cancel-in-progress: true

jobs:
  # Job 1: ä»å¤–è®¾çŸ©é˜µç”Ÿæˆæµ‹è¯•é…ç½®
  generate-test-matrix:
    runs-on: ubuntu-24.04
    outputs:
      test_suites: ${{ steps.generate_suites.outputs.matrix }}
      peripheral_groups: ${{ steps.generate_groups.outputs.matrix }}

    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Set up Python
        uses: actions/setup-python@0b93645e9fea7318ecaed2b359559ac225c90a2b # v5.3.0
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: pip install pyyaml

      - name: Generate test suites matrix
        id: generate_suites
        run: |
          python3 - <<'EOF'
          import yaml
          import json
          from pathlib import Path

          # è¯»å–å¤–è®¾çŸ©é˜µé…ç½®
          matrix_file = Path('boards/gd/scripts/gd32_peripheral_matrix.yaml')
          with open(matrix_file) as f:
              data = yaml.safe_load(f)

          # ä» test_groups ä¸­æ”¶é›†æµ‹è¯•ç”¨ä¾‹å’Œå¯¹åº”çš„æ¿å­
          test_groups = data.get('test_groups', {})
          test_suites = []

          for group_name, group_info in test_groups.items():
              tests = group_info.get('tests', [])
              boards = group_info.get('boards', [])

              # å¤„ç† boards: all çš„æƒ…å†µ
              if boards == 'all':
                  boards = list(data.get('boards', {}).keys())
              elif isinstance(boards, str):
                  boards = [b.strip() for b in boards.split(',')]

              # ä¸ºæ¯ä¸ªæµ‹è¯•ç”Ÿæˆæ¡ç›®
              for test in tests:
                  test_suites.append({
                      "name": test.replace('samples/', '').replace('tests/', '').replace('/', '_'),
                      "path": test,
                      "boards": ','.join(sorted(boards))
                  })

          # ç”Ÿæˆ GitHub Actions matrix
          matrix = {"test_suite": test_suites}

          import os
          with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
              f.write(f"matrix={json.dumps(matrix)}\n")

          print("Generated test suites matrix:")
          print(json.dumps(matrix, indent=2))
          EOF

      - name: Generate peripheral groups matrix
        id: generate_groups
        run: |
          python3 - <<'EOF'
          import yaml
          import json
          from pathlib import Path
          from collections import defaultdict

          # è¯»å–å¤–è®¾çŸ©é˜µé…ç½®
          matrix_file = Path('boards/gd/scripts/gd32_peripheral_matrix.yaml')
          with open(matrix_file) as f:
              data = yaml.safe_load(f)

          boards_data = data.get('boards', {})
          groups = []

          # ç”Ÿæˆå¤–è®¾ç‰¹å®šçš„æµ‹è¯•ç»„
          # ç»„1: I2C æµ‹è¯•
          i2c_boards = [name for name, info in boards_data.items()
                        if 'i2c' in info.get('peripherals', [])]
          if i2c_boards:
              i2c_tests = set()
              for board in i2c_boards:
                  for tests in boards_data[board].get('test_suites', {}).values():
                      for test in tests:
                          if 'i2c' in test.lower():
                              i2c_tests.add(test)

              if i2c_tests:
                  groups.append({
                      'name': 'i2c',
                      'boards': ','.join(sorted(i2c_boards)),
                      'tests': ','.join(sorted(i2c_tests)),
                      'description': 'I2C capable boards'
                  })

          # ç»„2: SPI æµ‹è¯•
          spi_boards = [name for name, info in boards_data.items()
                        if 'spi' in info.get('peripherals', [])]
          if spi_boards:
              spi_tests = set()
              for board in spi_boards:
                  for tests in boards_data[board].get('test_suites', {}).values():
                      for test in tests:
                          if 'spi' in test.lower():
                              spi_tests.add(test)

              if spi_tests:
                  groups.append({
                      'name': 'spi',
                      'boards': ','.join(sorted(spi_boards)),
                      'tests': ','.join(sorted(spi_tests)),
                      'description': 'SPI capable boards'
                  })

          # ç»„3: Shell æµ‹è¯•
          shell_tests = []
          for board_name, board_info in boards_data.items():
              for tests in board_info.get('test_suites', {}).values():
                  for test in tests:
                      if 'shell' in test.lower():
                          shell_tests.append(test)

          if shell_tests:
              groups.append({
                  'name': 'shell',
                  'boards': ','.join(sorted(boards_data.keys())),
                  'tests': ','.join(sorted(set(shell_tests))),
                  'description': 'Shell subsystem tests'
              })

          # ç»„4: åŸºç¡€æµ‹è¯•ï¼ˆæ‰€æœ‰æ¿å­ï¼‰
          basic_tests = set()
          for board_name, board_info in boards_data.items():
              basic_suite = board_info.get('test_suites', {}).get('basic', [])
              basic_tests.update(basic_suite)

          if basic_tests:
              groups.append({
                  'name': 'basic',
                  'boards': ','.join(sorted(boards_data.keys())),
                  'tests': ','.join(sorted(basic_tests)),
                  'description': 'Basic tests for all boards'
              })

          matrix = {'peripheral_config': groups} if groups else {'peripheral_config': []}

          import os
          with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
              f.write(f"matrix={json.dumps(matrix)}\n")

          print("Generated peripheral groups matrix:")
          print(json.dumps(matrix, indent=2))
          EOF

  # Job 2: æ£€æµ‹ GD32 ç›¸å…³æ”¹åŠ¨
  gd32-change-detection:
    runs-on: ubuntu-24.04
    outputs:
      has_changes: ${{ steps.check_changes.outputs.has_changes }}
      changed_boards: ${{ steps.detect_boards.outputs.boards }}
    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 0

      - name: Check if GD32 files changed
        id: check_changes
        run: |
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            CHANGED_FILES=$(git diff --name-only ${{ github.event.pull_request.base.sha }}..${{ github.event.pull_request.head.sha }})
          else
            CHANGED_FILES=$(git diff --name-only HEAD~1..HEAD)
          fi

          if echo "$CHANGED_FILES" | grep -E '^(boards/gd|soc/gd|dts/gd|drivers/)'; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "GD32 ç›¸å…³æ–‡ä»¶å‘ç”Ÿå˜æ›´"
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "æ—  GD32 ç›¸å…³æ–‡ä»¶å˜æ›´"
          fi

      - name: Detect changed boards
        id: detect_boards
        if: steps.check_changes.outputs.has_changes == 'true'
        run: |
          # æ£€æµ‹å˜æ›´çš„å¼€å‘æ¿
          BOARDS=$(find boards/gd -mindepth 1 -maxdepth 1 -type d -exec basename {} \; | grep -v scripts | sort | tr '\n' ',' | sed 's/,$//')
          echo "boards=$BOARDS" >> $GITHUB_OUTPUT
          echo "æ£€æµ‹åˆ°çš„ GD32 å¼€å‘æ¿: $BOARDS"

  # Job 3: GD32 å¼€å‘æ¿ç¼–è¯‘æµ‹è¯•ï¼ˆä½¿ç”¨åŠ¨æ€ç”Ÿæˆçš„æµ‹è¯•çŸ©é˜µï¼‰
  gd32-build-test:
    needs: [generate-test-matrix, gd32-change-detection]
    if: needs.gd32-change-detection.outputs.has_changes == 'true'
    runs-on: ubuntu-24.04
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.generate-test-matrix.outputs.test_suites) }}

    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@0b93645e9fea7318ecaed2b359559ac225c90a2b # v5.3.0
        with:
          python-version: '3.12'

      - name: Install Python dependencies
        run: |
          pip install pyyaml junitparser

      - name: Setup Zephyr environment
        run: |
          # å®‰è£…ç³»ç»Ÿä¾èµ–
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            git cmake ninja-build gperf ccache dfu-util \
            device-tree-compiler wget python3-dev python3-pip \
            python3-setuptools python3-tk python3-wheel xz-utils \
            file make gcc gcc-multilib g++-multilib libsdl2-dev \
            libmagic1

          # å®‰è£… west åˆ°ç”¨æˆ·ç›®å½•å¹¶æ·»åŠ åˆ°PATH
          pip3 install --user west
          echo "$HOME/.local/bin" >> $GITHUB_PATH

          # å®‰è£… Zephyr Python ä¾èµ–
          pip3 install --user -r scripts/requirements.txt

          # åˆå§‹åŒ– west workspace (å…³é”®æ­¥éª¤ï¼)
          west init -l .
          echo "West workspace initialized"

          # ============================================================
          # æ›´æ–° West æ¨¡å—ä¾èµ–
          # ============================================================

          # æ¨¡å—åˆ†ç±»è¯´æ˜ï¼š
          #
          # ã€æ ¸å¿ƒå¿…éœ€ã€‘- åŸºæœ¬ç¼–è¯‘å¿…é¡»ï¼š
          #   hal_gigadevice: GD32 HALåº“ï¼ŒåŒ…å«pinctrlå¤´æ–‡ä»¶ã€SOCé©±åŠ¨
          #   cmsis:          ARM CMSIS v5ï¼ŒCortex-Mæ ‡å‡†æ¥å£
          #   cmsis_6:        ARM CMSIS v6ï¼Œæ–°ç‰¹æ€§å’ŒDSPä¼˜åŒ–
          #
          # ã€æ‰©å±•åŠŸèƒ½ã€‘- é«˜çº§æµ‹è¯•éœ€è¦ï¼š
          #   fatfs:          FAT32æ–‡ä»¶ç³»ç»Ÿ (å­˜å‚¨å¡/Flashæµ‹è¯•)
          #   littlefs:       åµŒå…¥å¼æ–‡ä»¶ç³»ç»Ÿ (Flashç£¨æŸå‡è¡¡)
          #   mbedtls:        TLS/SSLåŠ å¯†åº“ (å®‰å…¨é€šä¿¡)
          #   net-tools:      ç½‘ç»œæµ‹è¯•å·¥å…· (Ethernet/WiFiæµ‹è¯•)
          #   lvgl:           GUIå›¾å½¢åº“ (LCD/æ˜¾ç¤ºæµ‹è¯•)
          #   mcuboot:        å®‰å…¨å¯åŠ¨åŠ è½½ç¨‹åº (å›ºä»¶å‡çº§)
          #   picolibc:       è½»é‡çº§Cåº“ (å‡å°å›ºä»¶å¤§å°)
          #   nanopb:         Protocol Buffers (IoTé€šä¿¡)
          #
          # ã€ä¸éœ€è¦çš„ã€‘ï¼š
          #   bsim_hw_models: è“ç‰™ä»¿çœŸ (ä»…Nordicæ¨¡æ‹Ÿå™¨)
          #   hal_nordic/nxp: å…¶ä»–å‚å•†HAL (ä¸å½±å“GD32)
          #   trusted-firmware: TEEå®‰å…¨å›ºä»¶ (é«˜çº§å®‰å…¨ç‰¹æ€§)
          # ============================================================

          echo "Current update strategy: ${{ env.WEST_UPDATE_STRATEGY }}"

          # æ ¸å¿ƒæ¨¡å— - æ€»æ˜¯æ›´æ–°
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“¦ Updating core modules..."
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          west update hal_gigadevice cmsis cmsis_6
          echo "âœ“ Core modules updated"

          # æ‰©å±•æ¨¡å— - æ ¹æ®ç­–ç•¥å†³å®š
          if [ "${{ env.WEST_UPDATE_STRATEGY }}" = "extended" ] || [ "${{ env.WEST_UPDATE_STRATEGY }}" = "full" ]; then
            echo ""
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "ğŸ“¦ Updating extended modules (FS + Network + Crypto)..."
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            west update fatfs littlefs mbedtls net-tools || echo "âš  Some extended modules may not exist"
            echo "âœ“ Extended modules updated"
          fi

          # å®Œæ•´æ¨¡å— - ä»…åœ¨fullç­–ç•¥æ—¶
          if [ "${{ env.WEST_UPDATE_STRATEGY }}" = "full" ]; then
            echo ""
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "ğŸ“¦ Updating full module set (Bootloader + GUI + Advanced)..."
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            west update mcuboot lvgl picolibc nanopb openthread || echo "âš  Some optional modules may not exist"
            echo "âœ“ Full modules updated"
          fi

          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… Module update completed"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "Strategy: ${{ env.WEST_UPDATE_STRATEGY }}"
          echo "Modules updated:"
          echo "  âœ“ hal_gigadevice (GD32 HAL + pinctrl headers)"
          echo "  âœ“ cmsis (ARM CMSIS v5)"
          echo "  âœ“ cmsis_6 (ARM CMSIS v6)"
          if [ "${{ env.WEST_UPDATE_STRATEGY }}" != "minimal" ]; then
            echo "  âœ“ Extended modules: fatfs, littlefs, mbedtls, net-tools"
          fi
          if [ "${{ env.WEST_UPDATE_STRATEGY }}" = "full" ]; then
            echo "  âœ“ Full modules: mcuboot, lvgl, picolibc, nanopb, openthread"
          fi

      - name: Download and setup Zephyr SDK
        run: |
          # ä¸‹è½½ Zephyr SDK (ä½¿ç”¨å®Œæ•´ç‰ˆæˆ–æ£€æŸ¥minimalæ˜¯å¦å¯ç”¨)
          cd ~
          ZEPHYR_SDK_VERSION=$(cat $GITHUB_WORKSPACE/SDK_VERSION)

          # å°è¯•ä¸‹è½½minimalç‰ˆæœ¬ï¼Œå¦‚æœå¤±è´¥åˆ™ä½¿ç”¨å®Œæ•´ç‰ˆ
          SDK_FILE="zephyr-sdk-${ZEPHYR_SDK_VERSION}_linux-x86_64_minimal.tar.xz"
          if ! wget -q https://github.com/zephyrproject-rtos/sdk-ng/releases/download/v${ZEPHYR_SDK_VERSION}/${SDK_FILE}; then
            SDK_FILE="zephyr-sdk-${ZEPHYR_SDK_VERSION}_linux-x86_64.tar.xz"
            wget -q https://github.com/zephyrproject-rtos/sdk-ng/releases/download/v${ZEPHYR_SDK_VERSION}/${SDK_FILE}
          fi

          tar xf ${SDK_FILE}

          # è®¾ç½® SDK
          # æ³¨æ„ï¼šGD32å¼€å‘æ¿åŒ…å«ä¸¤ç§æ¶æ„ï¼š
          # - ARM Cortex-Mç³»åˆ— (GD32F/E/A/L/C): éœ€è¦ arm-zephyr-eabi
          # - RISC-Vç³»åˆ— (GD32VF103): éœ€è¦ riscv64-zephyr-elf
          cd zephyr-sdk-${ZEPHYR_SDK_VERSION}

          # å®‰è£…ARMå·¥å…·é“¾ï¼ˆå¤§éƒ¨åˆ†GD32æ¿å­ï¼‰
          echo "Installing ARM toolchain for Cortex-M series..."
          ./setup.sh -t arm-zephyr-eabi -h -c

          # å®‰è£…RISC-Vå·¥å…·é“¾ï¼ˆGD32VF103ç³»åˆ—ï¼‰
          echo "Installing RISC-V toolchain for GD32VF103 series..."
          ./setup.sh -t riscv64-zephyr-elf -h -c

          echo "âœ“ Toolchains installed:"
          echo "  - arm-zephyr-eabi (GD32F/E/A/L/C series)"
          echo "  - riscv64-zephyr-elf (GD32VF103 series)"

          # å¯¼å‡º SDK ç¯å¢ƒå˜é‡
          echo "ZEPHYR_SDK_INSTALL_DIR=$HOME/zephyr-sdk-${ZEPHYR_SDK_VERSION}" >> $GITHUB_ENV

      - name: Run GD32 build test
        env:
          ZEPHYR_BASE: ${{ github.workspace }}
        run: |
          # ç¡®ä¿ west åœ¨ PATH ä¸­
          export PATH="$HOME/.local/bin:$PATH"

          # è®¾ç½® Zephyr ç¯å¢ƒ
          source zephyr-env.sh

          # éªŒè¯ç¯å¢ƒ
          west --version
          echo "ZEPHYR_BASE=$ZEPHYR_BASE"
          echo "ZEPHYR_SDK_INSTALL_DIR=$ZEPHYR_SDK_INSTALL_DIR"

          # è¿è¡Œ GD32 æœ¬åœ°æµ‹è¯•è„šæœ¬
          # å°†é€—å·åˆ†éš”çš„æ¿å­åˆ—è¡¨è½¬æ¢ä¸ºå¤šä¸ª -p å‚æ•°
          IFS=',' read -ra BOARDS <<< "${{ matrix.test_suite.boards }}"
          BOARD_ARGS=""
          for board in "${BOARDS[@]}"; do
            BOARD_ARGS="$BOARD_ARGS -p $board"
          done

          python3 boards/gd/scripts/gd32_local_tester.py \
            -T ${{ matrix.test_suite.path }} \
            $BOARD_ARGS \
            -j $(nproc) \
            --timeout 600 \
            --json-report gd32_test_${{ matrix.test_suite.name }}.json \
            --junit-xml gd32_test_${{ matrix.test_suite.name }}.xml

      - name: Generate firmware size report
        if: always()
        run: |
          echo "# GD32 Firmware Size Report - ${{ matrix.test_suite.name }}" > size_report.md
          echo "" >> size_report.md
          echo "| Board | Test | ELF Size | BIN Size | Flash Usage |" >> size_report.md
          echo "|-------|------|----------|----------|-------------|" >> size_report.md

          for build_dir in boards/gd/scripts/gd32_build_*/; do
            if [ -f "$build_dir/zephyr/zephyr.elf" ]; then
              board=$(basename $build_dir | sed 's/gd32_build_//' | sed 's/_samples.*//' | sed 's/_tests.*//')
              test=$(basename $build_dir | sed 's/.*_\(samples\|tests\)/\1/')

              if [ -f "$build_dir/zephyr/zephyr.elf" ]; then
                elf_size=$(stat -c%s "$build_dir/zephyr/zephyr.elf" 2>/dev/null || echo "0")
              else
                elf_size=0
              fi

              if [ -f "$build_dir/zephyr/zephyr.bin" ]; then
                bin_size=$(stat -c%s "$build_dir/zephyr/zephyr.bin" 2>/dev/null || echo "0")
              else
                bin_size=0
              fi

              elf_kb=$((elf_size / 1024))
              bin_kb=$((bin_size / 1024))

              echo "| $board | $test | ${elf_kb} KB | ${bin_kb} KB | ${bin_kb} KB |" >> size_report.md
            fi
          done

          echo "" >> size_report.md
          echo "Generated at: $(date)" >> size_report.md
          cat size_report.md

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@6f51ac03b9356f520e9adb1b1b7802705f340c2b # v4.5.0
        with:
          name: gd32-test-results-${{ matrix.test_suite.name }}
          path: |
            gd32_test_*.json
            gd32_test_*.xml
            size_report.md

      - name: Upload successful build artifacts (binaries)
        if: success()
        uses: actions/upload-artifact@6f51ac03b9356f520e9adb1b1b7802705f340c2b # v4.5.0
        with:
          name: gd32-binaries-${{ matrix.test_suite.name }}
          path: |
            boards/gd/scripts/gd32_build_*/zephyr/zephyr.elf
            boards/gd/scripts/gd32_build_*/zephyr/zephyr.bin
            boards/gd/scripts/gd32_build_*/zephyr/zephyr.hex
            boards/gd/scripts/gd32_build_*/zephyr/zephyr.map
          retention-days: 5

      - name: Upload failed build artifacts (debug)
        if: failure()
        uses: actions/upload-artifact@6f51ac03b9356f520e9adb1b1b7802705f340c2b # v4.5.0
        with:
          name: gd32-failed-builds-${{ matrix.test_suite.name }}
          path: |
            boards/gd/scripts/gd32_build_*/zephyr/zephyr.elf
            boards/gd/scripts/gd32_build_*/zephyr/zephyr.map
            boards/gd/scripts/gd32_build_*/zephyr/.config
            boards/gd/scripts/gd32_build_*/build.log
          retention-days: 3

      - name: Check build status
        if: always()
        run: |
          if [ -f gd32_test_${{ matrix.test_suite.name }}.json ]; then
            python3 -c "
          import json
          with open('gd32_test_${{ matrix.test_suite.name }}.json') as f:
              data = json.load(f)
              failed = data.get('summary', {}).get('failed', 0)
              if failed > 0:
                  print(f'âŒ {failed} ä¸ªæ„å»ºå¤±è´¥')
                  exit(1)
              else:
                  print('âœ… æ‰€æœ‰æ„å»ºé€šè¿‡')
            "
          fi

  # Job 4: å¤–è®¾åŠŸèƒ½æµ‹è¯•ï¼ˆä½¿ç”¨åŠ¨æ€ç”Ÿæˆçš„å¤–è®¾åˆ†ç»„ï¼‰
  gd32-peripheral-test:
    needs: [generate-test-matrix, gd32-change-detection]
    if: needs.gd32-change-detection.outputs.has_changes == 'true'
    runs-on: ubuntu-24.04
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.generate-test-matrix.outputs.peripheral_groups) }}

    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Set up Python
        uses: actions/setup-python@0b93645e9fea7318ecaed2b359559ac225c90a2b # v5.3.0
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: |
          pip install pyyaml junitparser
          # çœç•¥ Zephyr ç¯å¢ƒè®¾ç½®ï¼ˆä¸ä¸Šé¢ç›¸åŒï¼‰

      - name: Test peripheral support
        run: |
          export ZEPHYR_BASE=$GITHUB_WORKSPACE
          source zephyr-env.sh

          # åˆ†åˆ«æµ‹è¯•æ¯ä¸ªæµ‹è¯•ç”¨ä¾‹
          IFS=',' read -ra TESTS <<< "${{ matrix.peripheral_config.tests }}"
          for test in "${TESTS[@]}"; do
            echo "Testing $test on ${{ matrix.peripheral_config.description }}"

            # è¿‡æ»¤å¼€å‘æ¿è¿›è¡Œæµ‹è¯•
            IFS=',' read -ra BOARDS <<< "${{ matrix.peripheral_config.boards }}"
            for board in "${BOARDS[@]}"; do
              python3 boards/gd/scripts/gd32_local_tester.py \
                -T "$test" \
                -p "$board" \
                --timeout 300
            done
          done

  # Job 5: å‘å¸ƒæµ‹è¯•æŠ¥å‘Š
  gd32-test-report:
    needs: [gd32-build-test, gd32-peripheral-test]
    if: always()
    runs-on: ubuntu-24.04
    permissions:
      checks: write

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16 # v4.1.8
        with:
          path: artifacts

      - name: Install dependencies
        run: |
          pip install junitparser junit2html

      - name: Merge test results
        run: |
          find artifacts -name '*.xml' -type f
          junitparser merge artifacts/*/*.xml merged_results.xml || echo "No XML files found"

          if [ -f merged_results.xml ]; then
            junit2html merged_results.xml merged_results.html
          fi

      - name: Publish test results
        if: always()
        uses: EnricoMi/publish-unit-test-result-action@82082dac68ad6a19d980f8ce817e108b9f496c2a # v2.18.0
        with:
          check_name: GD32 Build Test Results
          files: |
            merged_results.xml
          comment_mode: off

      - name: Upload merged results
        if: always()
        uses: actions/upload-artifact@6f51ac03b9356f520e9adb1b1b7802705f340c2b # v4.5.0
        with:
          name: gd32-final-test-report
          path: |
            merged_results.xml
            merged_results.html
          retention-days: 5
