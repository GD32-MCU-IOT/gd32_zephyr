name: GD32 Boards CI Test

# 此 workflow 专注于 GD32 开发板的功能测试：
# - 编译测试（多种测试用例）
# - 外设功能测试（根据外设矩阵）
# - 测试报告生成
#
# 注意：代码格式检查（Checkpatch/GitLint/Identity等）由全局 compliance.yml 负责

on:
  push:
    branches:
      - main
      - develop
      - 'feature/gd32-*'
    paths:
      - 'boards/gd/**'
      - 'soc/gd/**'
      - 'dts/gd/**'
      - 'drivers/**'
  pull_request:
    branches:
      - main
      - develop
    paths:
      - 'boards/gd/**'
      - 'soc/gd/**'
      - 'dts/gd/**'
      - 'drivers/**'

permissions:
  contents: read
  checks: write

concurrency:
  group: ${{ github.workflow }}-${{ github.event_name }}-${{ github.head_ref || github.ref }}
  cancel-in-progress: true

jobs:
  # Job 1: 从外设矩阵生成测试配置
  generate-test-matrix:
    runs-on: ubuntu-24.04
    outputs:
      test_suites: ${{ steps.generate_suites.outputs.matrix }}
      peripheral_groups: ${{ steps.generate_groups.outputs.matrix }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: pip install pyyaml

      - name: Generate test suites matrix
        id: generate_suites
        run: |
          python3 - <<'EOF'
import yaml
import json
from pathlib import Path

# 读取外设矩阵配置
matrix_file = Path('boards/gd/scripts/gd32_peripheral_matrix.yaml')
with open(matrix_file) as f:
    data = yaml.safe_load(f)

# 收集所有唯一的测试用例
test_suites = set()
for board_name, board_info in data.get('boards', {}).items():
    for category, tests in board_info.get('test_suites', {}).items():
        for test in tests:
            test_suites.add(test)

# 生成 GitHub Actions matrix
matrix = {
    "test_suite": [
        {
            "name": test.replace('samples/', '').replace('tests/', '').replace('/', '_'),
            "path": test
        }
        for test in sorted(test_suites)
    ]
}

import os
with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
    f.write(f"matrix={json.dumps(matrix)}\n")

print("Generated test suites matrix:")
print(json.dumps(matrix, indent=2))
EOF

      - name: Generate peripheral groups matrix
        id: generate_groups
        run: |
          python3 - <<'EOF'
import yaml
import json
from pathlib import Path
from collections import defaultdict

# 读取外设矩阵配置
matrix_file = Path('boards/gd/scripts/gd32_peripheral_matrix.yaml')
with open(matrix_file) as f:
    data = yaml.safe_load(f)

boards_data = data.get('boards', {})
groups = []

# 生成外设特定的测试组
# 组1: I2C 测试
i2c_boards = [name for name, info in boards_data.items()
              if 'i2c' in info.get('peripherals', [])]
if i2c_boards:
    i2c_tests = set()
    for board in i2c_boards:
        for tests in boards_data[board].get('test_suites', {}).values():
            for test in tests:
                if 'i2c' in test.lower():
                    i2c_tests.add(test)

    if i2c_tests:
        groups.append({
            'name': 'i2c',
            'boards': ','.join(sorted(i2c_boards)),
            'tests': ','.join(sorted(i2c_tests)),
            'description': 'I2C capable boards'
        })

# 组2: SPI 测试
spi_boards = [name for name, info in boards_data.items()
              if 'spi' in info.get('peripherals', [])]
if spi_boards:
    spi_tests = set()
    for board in spi_boards:
        for tests in boards_data[board].get('test_suites', {}).values():
            for test in tests:
                if 'spi' in test.lower():
                    spi_tests.add(test)

    if spi_tests:
        groups.append({
            'name': 'spi',
            'boards': ','.join(sorted(spi_boards)),
            'tests': ','.join(sorted(spi_tests)),
            'description': 'SPI capable boards'
        })

# 组3: Shell 测试
shell_tests = []
for board_name, board_info in boards_data.items():
    for tests in board_info.get('test_suites', {}).values():
        for test in tests:
            if 'shell' in test.lower():
                shell_tests.append(test)

if shell_tests:
    groups.append({
        'name': 'shell',
        'boards': ','.join(sorted(boards_data.keys())),
        'tests': ','.join(sorted(set(shell_tests))),
        'description': 'Shell subsystem tests'
    })

# 组4: 基础测试（所有板子）
basic_tests = set()
for board_name, board_info in boards_data.items():
    basic_suite = board_info.get('test_suites', {}).get('basic', [])
    basic_tests.update(basic_suite)

if basic_tests:
    groups.append({
        'name': 'basic',
        'boards': ','.join(sorted(boards_data.keys())),
        'tests': ','.join(sorted(basic_tests)),
        'description': 'Basic tests for all boards'
    })

matrix = {'peripheral_config': groups} if groups else {'peripheral_config': []}

import os
with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
    f.write(f"matrix={json.dumps(matrix)}\n")

print("Generated peripheral groups matrix:")
print(json.dumps(matrix, indent=2))
EOF

  # Job 2: 检测 GD32 相关改动
  gd32-change-detection:
    runs-on: ubuntu-24.04
    outputs:
      has_changes: ${{ steps.check_changes.outputs.has_changes }}
      changed_boards: ${{ steps.detect_boards.outputs.boards }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check if GD32 files changed
        id: check_changes
        run: |
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            CHANGED_FILES=$(git diff --name-only ${{ github.event.pull_request.base.sha }}..${{ github.event.pull_request.head.sha }})
          else
            CHANGED_FILES=$(git diff --name-only HEAD~1..HEAD)
          fi

          if echo "$CHANGED_FILES" | grep -E '^(boards/gd|soc/gd|dts/gd|drivers/)'; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "GD32 相关文件发生变更"
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "无 GD32 相关文件变更"
          fi

      - name: Detect changed boards
        id: detect_boards
        if: steps.check_changes.outputs.has_changes == 'true'
        run: |
          # 检测变更的开发板
          BOARDS=$(find boards/gd -mindepth 1 -maxdepth 1 -type d -exec basename {} \; | grep -v scripts | sort | tr '\n' ',' | sed 's/,$//')
          echo "boards=$BOARDS" >> $GITHUB_OUTPUT
          echo "检测到的 GD32 开发板: $BOARDS"

  # Job 3: GD32 开发板编译测试（使用动态生成的测试矩阵）
  gd32-build-test:
    needs: [generate-test-matrix, gd32-change-detection]
    if: needs.gd32-change-detection.outputs.has_changes == 'true'
    runs-on: ubuntu-24.04
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.generate-test-matrix.outputs.test_suites) }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install Python dependencies
        run: |
          pip install pyyaml junitparser

      - name: Setup Zephyr environment
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            git cmake ninja-build gperf ccache dfu-util \
            device-tree-compiler wget python3-dev python3-pip \
            python3-setuptools python3-tk python3-wheel xz-utils \
            file make gcc gcc-multilib g++-multilib libsdl2-dev \
            libmagic1

          # 安装 west
          pip install west

          # 初始化 west workspace
          west init -l .
          west update -o=--depth=1 -n

          # 下载 Zephyr SDK
          cd ~
          ZEPHYR_SDK_VERSION=$(cat $GITHUB_WORKSPACE/SDK_VERSION)
          wget -q https://github.com/zephyrproject-rtos/sdk-ng/releases/download/v${ZEPHYR_SDK_VERSION}/zephyr-sdk-${ZEPHYR_SDK_VERSION}_linux-x86_64.tar.xz
          tar xf zephyr-sdk-${ZEPHYR_SDK_VERSION}_linux-x86_64.tar.xz
          cd zephyr-sdk-${ZEPHYR_SDK_VERSION}
          ./setup.sh -t arm-zephyr-eabi -h -c

      - name: Run GD32 build test
        run: |
          export ZEPHYR_BASE=$GITHUB_WORKSPACE
          source zephyr-env.sh

          # 运行 GD32 本地测试脚本
          python3 boards/gd/scripts/gd32_local_tester.py \
            -T ${{ matrix.test_suite.path }} \
            -j $(nproc) \
            --timeout 600 \
            --json-report gd32_test_${{ matrix.test_suite.name }}.json \
            --junit-xml gd32_test_${{ matrix.test_suite.name }}.xml

      - name: Generate firmware size report
        if: always()
        run: |
          echo "# GD32 Firmware Size Report - ${{ matrix.test_suite.name }}" > size_report.md
          echo "" >> size_report.md
          echo "| Board | Test | ELF Size | BIN Size | Flash Usage |" >> size_report.md
          echo "|-------|------|----------|----------|-------------|" >> size_report.md

          for build_dir in boards/gd/scripts/gd32_build_*/; do
            if [ -f "$build_dir/zephyr/zephyr.elf" ]; then
              board=$(basename $build_dir | sed 's/gd32_build_//' | sed 's/_samples.*//' | sed 's/_tests.*//')
              test=$(basename $build_dir | sed 's/.*_\(samples\|tests\)/\1/')

              if [ -f "$build_dir/zephyr/zephyr.elf" ]; then
                elf_size=$(stat -c%s "$build_dir/zephyr/zephyr.elf" 2>/dev/null || echo "0")
              else
                elf_size=0
              fi

              if [ -f "$build_dir/zephyr/zephyr.bin" ]; then
                bin_size=$(stat -c%s "$build_dir/zephyr/zephyr.bin" 2>/dev/null || echo "0")
              else
                bin_size=0
              fi

              elf_kb=$((elf_size / 1024))
              bin_kb=$((bin_size / 1024))

              echo "| $board | $test | ${elf_kb} KB | ${bin_kb} KB | ${bin_kb} KB |" >> size_report.md
            fi
          done

          echo "" >> size_report.md
          echo "Generated at: $(date)" >> size_report.md
          cat size_report.md

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: gd32-test-results-${{ matrix.test_suite.name }}
          path: |
            gd32_test_*.json
            gd32_test_*.xml
            size_report.md

      - name: Upload successful build artifacts (binaries)
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: gd32-binaries-${{ matrix.test_suite.name }}
          path: |
            boards/gd/scripts/gd32_build_*/zephyr/zephyr.elf
            boards/gd/scripts/gd32_build_*/zephyr/zephyr.bin
            boards/gd/scripts/gd32_build_*/zephyr/zephyr.hex
            boards/gd/scripts/gd32_build_*/zephyr/zephyr.map
          retention-days: 5

      - name: Upload failed build artifacts (debug)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: gd32-failed-builds-${{ matrix.test_suite.name }}
          path: |
            boards/gd/scripts/gd32_build_*/zephyr/zephyr.elf
            boards/gd/scripts/gd32_build_*/zephyr/zephyr.map
            boards/gd/scripts/gd32_build_*/zephyr/.config
            boards/gd/scripts/gd32_build_*/build.log
          retention-days: 3

      - name: Check build status
        if: always()
        run: |
          if [ -f gd32_test_${{ matrix.test_suite.name }}.json ]; then
            python3 -c "
import json
with open('gd32_test_${{ matrix.test_suite.name }}.json') as f:
    data = json.load(f)
    failed = data.get('summary', {}).get('failed', 0)
    if failed > 0:
        print(f'❌ {failed} 个构建失败')
        exit(1)
    else:
        print('✅ 所有构建通过')
            "
          fi

  # Job 4: 外设功能测试（使用动态生成的外设分组）
  gd32-peripheral-test:
    needs: [generate-test-matrix, gd32-change-detection]
    if: needs.gd32-change-detection.outputs.has_changes == 'true'
    runs-on: ubuntu-24.04
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.generate-test-matrix.outputs.peripheral_groups) }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: |
          pip install pyyaml junitparser
          # 省略 Zephyr 环境设置（与上面相同）

      - name: Test peripheral support
        run: |
          export ZEPHYR_BASE=$GITHUB_WORKSPACE
          source zephyr-env.sh

          # 分别测试每个测试用例
          IFS=',' read -ra TESTS <<< "${{ matrix.peripheral_config.tests }}"
          for test in "${TESTS[@]}"; do
            echo "Testing $test on ${{ matrix.peripheral_config.description }}"

            # 过滤开发板进行测试
            IFS=',' read -ra BOARDS <<< "${{ matrix.peripheral_config.boards }}"
            for board in "${BOARDS[@]}"; do
              python3 boards/gd/scripts/gd32_local_tester.py \
                -T "$test" \
                -p "$board" \
                --timeout 300
            done
          done

  # Job 5: 发布测试报告
  gd32-test-report:
    needs: [gd32-build-test, gd32-peripheral-test]
    if: always()
    runs-on: ubuntu-24.04
    permissions:
      checks: write

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Install dependencies
        run: |
          pip install junitparser junit2html

      - name: Merge test results
        run: |
          find artifacts -name '*.xml' -type f
          junitparser merge artifacts/*/*.xml merged_results.xml || echo "No XML files found"

          if [ -f merged_results.xml ]; then
            junit2html merged_results.xml merged_results.html
          fi

      - name: Publish test results
        if: always()
        uses: EnricoMi/publish-unit-test-result-action@v2
        with:
          check_name: GD32 Build Test Results
          files: |
            merged_results.xml
          comment_mode: off

      - name: Upload merged results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: gd32-final-test-report
          path: |
            merged_results.xml
            merged_results.html

  # 注意：代码格式检查（Checkpatch/GitLint/Identity/License）已由全局 compliance.yml 和 coding_guidelines.yml 负责
  # 这些检查会自动应用于所有 PR，包括 GD32 相关的修改
  # 如需额外的 GD32 特定格式检查，可在此添加
